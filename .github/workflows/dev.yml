# Deploy to Staging on push to development branch
name: Deploy Staging

on:
  push:
    branches: [develop]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          if [ -f src/lambda/requirements-test.txt ]; then
            pip install -r src/lambda/requirements-test.txt
          else
            pip install pytest
          fi

      - name: Run pytest
        run: pytest src/lambda/tests -v

      - name: Build Pillow Lambda layer
        working-directory: infra
        run: |
          mkdir -p build/layer/python/lib/python3.12/site-packages
          pip install -r layer_requirements.txt \
            -t build/layer/python/lib/python3.12/site-packages \
            --quiet \
            --platform manylinux2014_x86_64 \
            --only-binary=:all:
          cd build/layer && zip -rq ../pillow_layer.zip python

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"
          terraform_wrapper: false

      - name: Terraform init
        working-directory: infra
        run: terraform init

      - name: Terraform plan
        working-directory: infra
        run: terraform plan -var="githubOrgRepo=${{ github.repository }}" -no-color

      - name: Terraform apply
        working-directory: infra
        run: terraform apply -var="githubOrgRepo=${{ github.repository }}" -auto-approve -no-color

      - name: Set up Node for SPA build
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build React SPA frontend
        working-directory: src/web/spa
        run: |
          npm ci
          npm run build

      - name: Deploy frontend to S3
        run: |
          API_URL=$(terraform -chdir=infra output -raw apiInvokeUrl)
          POOL_ID=$(terraform -chdir=infra output -raw cognitoUserPoolId)
          CLIENT_ID=$(terraform -chdir=infra output -raw cognitoClientId)
          # Write runtime config for SPA (served as /config.js from bucket root)
          cat > src/web/spa/dist/config.js <<'CONFIGEOF'
          window.API_BASE_URL = "API_URL_PLACEHOLDER";
          window.COGNITO_USER_POOL_ID = "POOL_ID_PLACEHOLDER";
          window.COGNITO_CLIENT_ID = "CLIENT_ID_PLACEHOLDER";
          window.CATEGORIES_CACHE_KEY = "ows_categories";
          window.getCategoriesFromCache = function () { try { var r = localStorage.getItem(window.CATEGORIES_CACHE_KEY); return r ? JSON.parse(r) : []; } catch (e) { return []; } };
          window.saveCategoriesToCache = function (cats) { try { if (!cats || !Array.isArray(cats)) return; var list = cats.map(function (c) { return { id: c.PK || c.id || "", name: c.name || c.PK || c.id || "" }; }); localStorage.setItem(window.CATEGORIES_CACHE_KEY, JSON.stringify(list)); } catch (e) {} };
          CONFIGEOF
          sed -i "s|API_URL_PLACEHOLDER|$API_URL|g; s|POOL_ID_PLACEHOLDER|$POOL_ID|g; s|CLIENT_ID_PLACEHOLDER|$CLIENT_ID|g" src/web/spa/dist/config.js
          sed -i "s|API_URL_PLACEHOLDER|$API_URL|g; s|POOL_ID_PLACEHOLDER|$POOL_ID|g; s|CLIENT_ID_PLACEHOLDER|$CLIENT_ID|g" src/web/spa/dist/index.html
          # Ensure Cognito auth bootstrap script is deployed alongside SPA
          cp src/web/auth.js src/web/spa/dist/auth.js
          BUCKET=$(terraform -chdir=infra output -raw websiteStagingBucket)
          if [ -d "src/web/spa/dist" ]; then
            aws s3 sync src/web/spa/dist s3://$BUCKET/ --delete
          else
            echo "No frontend to deploy"
          fi

      - name: Invalidate CloudFront cache
        run: |
          DIST_ID=$(terraform -chdir=infra output -raw cloudfrontStagingId)
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"

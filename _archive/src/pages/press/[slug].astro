---
import Layout from '../../components/Layout.astro';
import { client } from '@/lib/sanity';
import { portableTextToHtml } from '@/lib/portableText.ts';
import groq from 'groq';
import type { PortableTextBlock } from '@portabletext/types';
import type { SanityPress } from '@/types/sanity';

interface FullPress extends SanityPress {
  content?: PortableTextBlock[];
}

export async function getStaticPaths() {
  const pressSlugs = await client.fetch<{ slug: string }[]>(groq`
    *[_type == "press" && defined(slug.current)]{
      "slug": slug.current
    }
  `);

  return pressSlugs.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;

const press = await client.fetch<FullPress | null>(
  groq`*[_type == "press" && slug.current == $slug][0]{
    _id,
    title,
    date,
    description,
    tags,
    "slug": slug.current,
    "heroImage": heroImage{alt, asset->{url}},
    content
  }`,
  { slug }
);

if (!press) {
  return Astro.redirect('/press');
}

const formattedDate = press.date
  ? new Date(press.date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : '';

const contentHtml = portableTextToHtml(press.content);
---

<Layout title={`${press.title} â€” Orange Whip`} description={press.description}>
  <main class="container-max section-padding">
    <div class="max-w-4xl mx-auto">
      <div class="mb-8">
        <a href="/press" class="text-primary-400 hover:text-primary-300 transition-colors duration-200">
          &larr; Back to all press
        </a>
      </div>

      <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-display font-bold text-gradient mb-4">{press.title}</h1>
        <p class="text-lg text-secondary-400 mb-4">{formattedDate}</p>
        {press.tags && press.tags.length > 0 && (
          <div class="flex justify-center flex-wrap gap-2">
            {press.tags.map((tag) => (
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-secondary-800 text-primary-400">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      {press.heroImage?.asset?.url && (
        <div class="mb-12">
          <img
            src={press.heroImage.asset.url}
            alt={press.heroImage.alt || press.title}
            class="w-full max-w-3xl mx-auto rounded-lg shadow-lg border-4 border-secondary-800"
          />
        </div>
      )}

      {contentHtml && (
        <article class="prose prose-invert prose-lg max-w-none mx-auto">
          <div set:html={contentHtml} />
        </article>
      )}
    </div>
  </main>
</Layout>

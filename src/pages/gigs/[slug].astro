---
import Layout from '../../components/Layout.astro';
import { client } from '@/lib/sanity';
import { portableTextToHtml } from '@/lib/portableText.ts';
import groq from 'groq';
import type { PortableTextBlock } from '@portabletext/types';
import type { SanityGig } from '@/types/sanity';

interface FullGig extends SanityGig {
  posterUrl?: string;
  galleryUrls?: string[];
  content?: PortableTextBlock[];
}

export async function getStaticPaths() {
  const gigSlugs = await client.fetch<{ slug: string }[]>(groq`
    *[_type == "gig" && defined(slug.current)]{
      "slug": slug.current
    }
  `);

  return gigSlugs.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;

const gig = await client.fetch<FullGig | null>(
  groq`*[_type == "gig" && slug.current == $slug][0]{
    _id,
    title,
    date,
    venue,
    address,
    city,
    description,
    isUpcoming,
    "slug": slug.current,
    "posterUrl": poster.asset->url,
    "galleryUrls": gallery[].asset->url,
    content
  }`,
  { slug }
);

if (!gig) {
  return Astro.redirect('/gigs');
}

const formattedDate = gig.date
  ? new Date(gig.date).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : 'Date TBA';

const contentHtml = portableTextToHtml(gig.content);
---

<Layout title={`${gig.title} â€” Orange Whip`} description={gig.description}>
  <main class="container-max section-padding">
    <div class="max-w-4xl mx-auto">
      <div class="mb-8">
        <a href="/gigs" class="text-primary-400 hover:text-primary-300 transition-colors duration-200">
          &larr; Back to all gigs
        </a>
      </div>

      <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-display font-bold text-gradient mb-4">{gig.title}</h1>
        <p class="text-xl text-secondary-300 font-medium mb-2">{formattedDate}</p>
        <p class="text-lg text-secondary-400">{gig.venue}</p>
        {gig.address && <p class="text-secondary-500">{gig.address}</p>}
        {gig.city && <p class="text-secondary-500">{gig.city}</p>}
      </header>

      {gig.posterUrl && (
        <div class="mb-12">
          <img
            src={gig.posterUrl}
            alt={gig.title}
            class="w-full max-w-2xl mx-auto rounded-lg shadow-lg border-4 border-secondary-800"
          />
        </div>
      )}

      {contentHtml && (
        <article class="prose prose-invert prose-lg max-w-none mx-auto mb-12">
          <div set:html={contentHtml} />
        </article>
      )}

      {gig.galleryUrls && gig.galleryUrls.length > 0 && (
        <section class="mb-12">
          <h2 class="text-3xl font-display font-bold text-center text-gradient mb-8">Gallery</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {gig.galleryUrls.map((url) => (
              <img
                src={url}
                alt={`${gig.title} gallery image`}
                class="w-full h-48 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow"
              />
            ))}
          </div>
        </section>
      )}

      <div class="text-center">
        {gig.isUpcoming ? (
          <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-primary-600 text-white">
            Upcoming Show
          </span>
        ) : (
          <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-secondary-800 text-secondary-300">
            Past Show
          </span>
        )}
      </div>
    </div>
  </main>
</Layout>

---
import Layout from '../../components/Layout.astro';
import { Header } from '../../components/react/Header';
import { Footer } from '../../components/react/Footer';
import { client } from '@/lib/sanity';
import groq from 'groq';
import type { SanityDaily } from '@/types/sanity';

interface DailyPath {
  slug: string;
}

export async function getStaticPaths() {
  const slugs = await client.fetch<DailyPath[]>(groq`
    *[_type == "daily" && defined(slug.current)]{
      "slug": slug.current
    }
  `);

  return slugs
    .filter(entry => !!entry.slug)
    .map(entry => ({
      params: { date: entry.slug },
      props: { slug: entry.slug },
    }));
}

const { slug } = Astro.props;
const daily = await client.fetch<SanityDaily | null>(
  groq`
    *[_type == "daily" && slug.current == $slug][0]{
      _id,
      title,
      date,
      generatedAt,
      "slug": slug.current,
      items[]{
        _type,
        title,
        description,
        link,
        source,
        publishedAt,
        media[]{
          _type,
          kind,
          url,
          caption
        }
      }
    }
  `,
  { slug }
);

if (!daily) {
  throw new Error(`Daily roundup not found for slug: ${slug}`);
}

const dailyDate = daily.date ? new Date(daily.date) : null;
const formattedDate = dailyDate && !Number.isNaN(dailyDate.getTime())
  ? dailyDate.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : daily.title ?? slug;
const publishedOn = daily.generatedAt
  ? new Date(daily.generatedAt).toLocaleString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      timeZoneName: 'short',
    })
  : null;
---

<Layout title={`Vancouver Roundup - ${formattedDate} â€” Orange Whip`} description={`Daily Vancouver music headlines roundup for ${formattedDate}`}>
  <Header client:load />

  <main class="container-max section-padding">
    <div class="max-w-4xl mx-auto space-y-12">
      <div class="mb-8">
        <a href="/daily" class="text-primary-400 hover:text-primary-300 transition-colors duration-200">
          &larr; Back to Daily Roundups
        </a>
      </div>

      <div class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-display font-bold text-gradient mb-4">Vancouver Music Roundup</h1>
        <p class="text-xl text-secondary-300">{formattedDate}</p>
        {publishedOn && (
          <p class="text-sm text-secondary-500 mt-2">Generated {publishedOn}</p>
        )}
      </div>

      <section class="space-y-6">
        {daily.items && daily.items.length > 0 ? (
          daily.items.map((item, index) => {
            const itemDate = item.publishedAt ? new Date(item.publishedAt) : null;
            const formattedItemDate = itemDate && !Number.isNaN(itemDate.getTime())
              ? itemDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })
              : null;

            return (
              <article class="bg-secondary-900 border border-secondary-700 rounded-lg p-6" key={`${daily._id}-${index}`}>
                <header class="space-y-2">
                  <h2 class="text-2xl font-semibold text-white">{item.title ?? 'Untitled story'}</h2>
                  <div class="flex flex-wrap gap-3 text-xs uppercase tracking-wide text-secondary-500">
                    {item.source && <span>{item.source}</span>}
                    {formattedItemDate && <span>{formattedItemDate}</span>}
                    {item.link && (
                      <a
                        href={item.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-primary-400 hover:text-primary-300"
                      >
                        Read original
                      </a>
                    )}
                  </div>
                </header>

                {item.description && (
                  <p class="mt-4 text-secondary-200 leading-relaxed">{item.description}</p>
                )}

                {item.media && item.media.length > 0 && (
                  <div class="mt-5 grid gap-4 md:grid-cols-2">
                    {item.media.map((media, mediaIndex) => (
                      <figure
                        key={`${daily._id}-${index}-media-${mediaIndex}`}
                        class="bg-secondary-800 rounded-md overflow-hidden border border-secondary-700"
                      >
                        {media.kind === 'image' && media.url ? (
                          <img src={media.url} alt={media.caption ?? ''} class="w-full h-auto" loading="lazy" />
                        ) : (
                          <a
                            href={media.url ?? '#'}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="block p-4 text-primary-300 hover:text-primary-200"
                          >
                            {media.kind === 'video' ? 'Watch video' : 'View media'}
                          </a>
                        )}
                        {media.caption && (
                          <figcaption class="px-4 py-3 text-xs text-secondary-400 bg-secondary-900">
                            {media.caption}
                          </figcaption>
                        )}
                      </figure>
                    ))}
                  </div>
                )}
              </article>
            );
          })
        ) : (
          <div class="text-center py-16 bg-secondary-900 border border-secondary-700 rounded-lg">
            <p class="text-2xl text-secondary-300">No stories were captured for this date.</p>
            <p class="text-lg text-secondary-400 mt-2">Check back tomorrow for fresh highlights.</p>
          </div>
        )}
      </section>
    </div>
  </main>

  <Footer client:load />
</Layout>
